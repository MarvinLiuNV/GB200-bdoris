SETTINGS:
  name: HEALTH

VARS:
  CLUSTER_NAME: "<CLUSTER_NAME>"
  CONFIGURATION: "<CONFIGURATION>"
  BENCHMARK: "<BENCHMARK>"
  TAGS: "<TAG>"
  SLURM_PARTITION: ""
  CONTAINER: ''


  SLURM_PARTITION: "L40S"
  NCCL_EXP_BW: 10
  CONTAINER: ""
  NCCL_SOCKET: "enp3s0f0"
  MELLANOX_VISIBLE_DEVICES: "2,3"
  CUDA_VISIBLE_DEVICES: 0,1,2,3
  NCCL_IB_HCA: mlx5_2:1,mlx5_3:1
  NTASKS_PER_NODE: 4
  NUM_GPUS: 4
  NCCL_DEBUG: "warn"
  JOB_ID: 1
#  NCCL_IB_GID_INDEX: '3'
  SLURM_JOBS: ''
  GROUP_FILTER: ''
  HOSTS: ""
  NCCL_MNNVL_ENABLE: 1
  NCCL_P2P_DISABLE: 0
  NCCL_SHM_DISABLE: 0
  NCCL_PXN_DISABLE: 0
  NCCL_P2P_PXN_LEVEL: 1
  SPLIT_MASK: 0x0

JOBS:
  # NCCL All Reduce host isolation
  - $nccl_job[nccl_all_to_all]$ --NCCL_TESTS_SPLIT_MASK={SPLIT_MASK} --NCCL_CROSS_NIC=1 --NCCL_ALGO=ring
    --NCCL_IB_SPLIT_DATA_ON_QPS=0 --NCCL_IB_QPS_PER_CONNECTION=4 --NCCL_BUFFSIZE=4194304
    $slurm_jobs
    $print_commands $host_bw_analysis $benchmark_tag$

ALIAS:
  nccl_job benchmark minbytes=4G maxbytes=4G n=10 f=2 g=1: jobs hpc nccl_tests --benchmark=$benchmark
            --minbytes=$minbytes --n=$n --f=$f --g=$g --w=50 --maxbytes=$maxbytes hpc_runner --runner=srun 
            jobs hpc hpc_configuration srun --MELLANOX_VISIBLE_DEVICES={MELLANOX_VISIBLE_DEVICES} --ntasks_per_node={NTASKS_PER_NODE} --container_image={CONTAINER} --num_gpus={NUM_GPUS} --partition={SLURM_PARTITION}
            jobs hpc hpc_configuration cuda --CUDA_VISIBLE_DEVICES={CUDA_VISIBLE_DEVICES} ucx --UCX_NET_DEVICES={NCCL_SOCKET}
            jobs hpc hpc_configuration nccl --NCCL_IB_ADAPTIVE_ROUTING=1 --NCCL_SOCKET_IFNAME={NCCL_SOCKET} --NCCL_IB_GID_INDEX=3 --NCCL_IB_TC=96 --NCCL_IB_HCA={NCCL_IB_HCA} --NCCL_DEBUG=warn --NCCL_NET_PLUGIN=none
            --NCCL_MNNVL_ENABLE={NCCL_MNNVL_ENABLE} --NCCL_P2P_DISABLE={NCCL_P2P_DISABLE} --NCCL_SHM_DISABLE={NCCL_SHM_DISABLE} --NCCL_PXN_DISABLE={NCCL_PXN_DISABLE} --NCCL_P2P_PXN_LEVEL={NCCL_P2P_PXN_LEVEL}

#    --NCCL_NET_GDR_LEVEL=PHB --NCCL_NET_GDR_C2C=1 --NCCL_MIN_CTAS=$ctas --NCCL_IB_QPS_PER_CONNECTION=$num_qps

  # analysis
  host_bw_analysis: analysis worker_oriented_metrics --expression='out_bus_bw>{NCCL_EXP_BW}' --remove_worker_on_failure=true

  # tags
  benchmark_tag benchmark={BENCHMARK}: tagging --cluster_name={CLUSTER_NAME} --configuration={CONFIGURATION} --benchmark=$benchmark --tags={TAGS}

  print_commands: jobs log_configuration --commands_info=true

  slurm_jobs job_id={JOB_ID}: jobs slurm_allocator --hostlist={HOSTS} --allocation_group_id=$job_id --partition={SLURM_PARTITION}
  # modifier
