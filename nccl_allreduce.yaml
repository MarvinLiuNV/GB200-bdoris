SETTINGS:
  name: HEALTH

VARS:
  CLUSTER_NAME: "<CLUSTER_NAME>"
  CONFIGURATION: "<CONFIGURATION>"
  TAGS: "<TAG>"
  SLURM_PARTITION: ""
  CONTAINER: ''

  # NCCL_MNNVL_ENABLE: ''

  SLURM_PARTITION: "L40S"
  NCCL_EXP_BW: 10
  CONTAINER: "/mswg2/E2E/Regression_logs/squash/nccl_v2.24.3-1"
  NCCL_SOCKET: "enp3s0f0"
  MELLANOX_VISIBLE_DEVICES: "2,3"
  CUDA_VISIBLE_DEVICES: 0,1,2,3
  NCCL_IB_HCA: mlx5_2:1,mlx5_3:1
  NTASKS_PER_NODE: '4'
  NUM_GPUS: '4'
  NCCL_DEBUG: "warn"
  NCCL_IB_GID_INDEX: '3'

JOBS:
  # NCCL All Reduce santiy
  - $nccl_job[nccl_all_reduce]$ --NCCL_TESTS_SPLIT_MASK=0 --NCCL_CROSS_NIC=1 --NCCL_ALGO=ring
    --NCCL_IB_SPLIT_DATA_ON_QPS=0 --NCCL_IB_QPS_PER_CONNECTION=4 --NCCL_BUFFSIZE=4194304
    $slurm_all_hosts $group_1_host_filter
    $print_commands $host_bw_analysis $benchmark_tag[single_node_nccl_all_reduce]$

ALIAS:
  nccl_job benchmark minbytes=1G maxbytes=1G n=10 f=2 g=1 : jobs hpc nccl_tests --benchmark=$benchmark
            --minbytes=$minbytes --maxbytes=$maxbytes --n=$n --f=$f --g=$g --w=50  hpc_runner --runner=srun log_configuration --commands_info=true
              jobs hpc hpc_configuration srun --MELLANOX_VISIBLE_DEVICES=2,3 --ntasks_per_node=4 --container_image={CONTAINER} --num_gpus=4 --partition=L40S--rm=pyt_init.store
              jobs hpc hpc_configuration cuda --CUDA_VISIBLE_DEVICES={CUDA_VISIBLE_DEVICES}
              jobs hpc hpc_configuration nccl --NCCL_IB_GID_INDEX=3 --NCCL_IB_TC=96 --NCCL_SOCKET_IFNAME={NCCL_SOCKET} --NCCL_IB_HCA={NCCL_IB_HCA} --NCCL_DEBUG=warn --NCCL_NET_PLUGIN=none
#    --NCCL_MNNVL_ENABLE={NCCL_MNNVL_ENABLE}

  # slurm jobs
  slurm_all_hosts id=1: jobs slurm_allocator --all_hosts=true --allocation_group_id=$id --partition={SLURM_PARTITION}

  # modifier
  group_1_host_filter: pairing_allocation pairing_rules k_node_grouper --k=1 --node_type=Host

  # analysis
  host_bw_analysis: analysis worker_oriented_metrics --expression='out_bus_bw>{NCCL_EXP_BW}' --remove_worker_on_failure=true

  # tags
  benchmark_tag benchmark: tagging --cluster_name={CLUSTER_NAME} --configuration={CONFIGURATION} --benchmark=$benchmark --tags={TAGS}

  print_commands: jobs log_configuration --commands_info=true
